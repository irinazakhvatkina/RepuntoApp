//
//  BlogViewController.swift
//  RepuntoApp
//
//  Created by Irina Zakhvatkina on 02/08/25.
//

import UIKit
import SnapKit

class BlogViewController: UIViewController, UITableViewDataSource, UITableViewDelegate {

    var isDarkMode: Bool {
        return traitCollection.userInterfaceStyle == .dark
    }

    var burgerButton: UIButton!
    var themeToggleButton: UIButton!

    private var articles: [Article] = [] // сюда загрузим статьи
    private let tableView = UITableView()

    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = UIColor(named: "background")
        setupNavigationBar()
        updateTheme()
        
        title = "Статьи"
        setupTableView()
        loadSampleArticles()
    }

    override func traitCollectionDidChange(_ previousTraitCollection: UITraitCollection?) {
        super.traitCollectionDidChange(previousTraitCollection)
        if traitCollection.hasDifferentColorAppearance(comparedTo: previousTraitCollection) {
            updateTheme()
        }
    }

    func setupNavigationBar() {
        let logoButton = UIButton(type: .system)
        let logoImage = UIImage(named: "logo")?.withRenderingMode(.alwaysOriginal)
        logoButton.setImage(logoImage, for: .normal)
        logoButton.imageView?.contentMode = .scaleAspectFit
        logoButton.addTarget(self, action: #selector(logoTapped), for: .touchUpInside)
        logoButton.frame = CGRect(x: 0, y: 0, width: 28, height: 28)
        navigationItem.titleView = logoButton

        burgerButton = UIButton(type: .system)
        let burgerImage = UIImage(systemName: "line.3.horizontal")
        burgerButton.setImage(burgerImage, for: .normal)
        burgerButton.frame = CGRect(x: 0, y: 0, width: 28, height: 28)
        burgerButton.addTarget(self, action: #selector(burgerTapped), for: .touchUpInside)
        navigationItem.leftBarButtonItem = UIBarButtonItem(customView: burgerButton)

        themeToggleButton = UIButton(type: .system)
        themeToggleButton.frame = CGRect(x: 0, y: 0, width: 28, height: 28)
        themeToggleButton.addTarget(self, action: #selector(toggleTheme), for: .touchUpInside)
        navigationItem.rightBarButtonItem = UIBarButtonItem(customView: themeToggleButton)
    }

    @objc func toggleTheme() {
        let newStyle: UIUserInterfaceStyle = isDarkMode ? .light : .dark
        view.window?.overrideUserInterfaceStyle = newStyle
    }

    func updateTheme() {
        let iconColor = UIColor(named: "primaryText")
        burgerButton.tintColor = iconColor
        themeToggleButton.tintColor = iconColor
        let newIconName = isDarkMode ? "sun.max" : "moon.stars"
        let newImage = UIImage(systemName: newIconName)
        themeToggleButton.setImage(newImage, for: .normal)
        navigationController?.navigationBar.tintColor = UIColor(named: "primaryText")
    }

    @objc func burgerTapped() {
        let alert = UIAlertController(title: nil, message: nil, preferredStyle: .actionSheet)

        alert.addAction(UIAlertAction(title: "Главная", style: .default, handler: { _ in
            let mapVC = MainViewController()
            self.navigationController?.pushViewController(mapVC, animated: true)
        }))
        alert.addAction(UIAlertAction(title: "Карта", style: .default, handler: { _ in
            let mapVC = MapViewController()
            self.navigationController?.pushViewController(mapVC, animated: true)
        }))
        alert.addAction(UIAlertAction(title: "Отмена", style: .cancel))
        if let popover = alert.popoverPresentationController {
            popover.barButtonItem = navigationItem.leftBarButtonItem
        }
        present(alert, animated: true)
    }

    @objc func logoTapped() {
        navigationController?.popToRootViewController(animated: true)
    }

    func setupTableView() {
        view.addSubview(tableView)
        tableView.snp.makeConstraints { make in
            make.edges.equalToSuperview()
        }
        tableView.register(ArticleCell.self, forCellReuseIdentifier: "ArticleCell")
        tableView.dataSource = self
        tableView.delegate = self
        tableView.rowHeight = UITableView.automaticDimension
        tableView.estimatedRowHeight = 160
    }

    func loadSampleArticles() {
        articles = [
            Article(
                title: "Как правильно сортировать отходы дома?",
                image: UIImage(named: "id1"),
                summary: "Простые шаги для сортировки отходов в домашних условиях.",
                date: Date(),
                content: "В современном мире, где экологическая ответственность становится не просто модным трендом, но и жизненной необходимостью, домашняя сортировка отходов – это один из самых простых и эффективных способов внести свой вклад в сохранение планеты. Забудьте о том, что это сложно или требует много места. На самом деле, это гораздо проще, чем кажется. Почему это важно? Каждый день мы выбрасываем огромное количество мусора, который, попадая на свалки, разлагается сотни лет, выделяя вредные вещества и занимая драгоценные земли. Переработка же позволяет вернуть ценные материалы в производственный цикл, сократить потребление природных ресурсов, уменьшить выбросы парниковых газов и даже сэкономить энергию. Представьте, сколько пластиковых бутылок, стеклянных банок и картонных коробок, которые мы выбрасываем, могли бы получить вторую жизнь! С чего начать? Основы сортировки Не нужно превращать свою кухню в полноценный пункт приема вторсырья. Для начала достаточно выделить несколько контейнеров или пакетов. Вот основные категории, на которые обычно сортируют отходы: Бумага и картон: Сюда относятся газеты, журналы, рекламные буклеты, картонные коробки (без остатков пищи и жира), бумажная упаковка. Важно убедиться, что бумага чистая и сухая. Мятые, мокрые или жирные бумажные отходы не подходят для переработки. Пластик: Это самая разнообразная категория, и здесь важно обращать внимание на маркировку – треугольник с цифрой внутри. Чаще всего перерабатывают пластик с маркировкой 1 (PET/PETE – бутылки из-под напитков, масла) и 2 (HDPE/PE-HD – бутылки из-под моющих средств, молока). Пластиковые пакеты, пленка и некоторые виды упаковки могут требовать отдельного сбора или не приниматься на переработку вовсе. Все пластиковые емкости перед сдачей желательно ополоснуть и, по возможности, смять, чтобы уменьшить объем. Стекло: Бутылки и банки всех цветов (бесцветное, коричневое, зеленое). Перед выбросом убедитесь, что они чистые, без крышек и этикеток (хотя последние обычно не мешают). Зеркала, оконное стекло, керамика и хрусталь не относятся к перерабатываемому стеклу. Металл: Алюминиевые банки из-под напитков, консервные банки (чистые), алюминиевая фольга (чистая). Металлические крышки от стеклянных банок также обычно принимаются. Что делать с остальным? Органические отходы: Пищевые отходы (остатки еды, кожура овощей и фруктов, чайные пакетики, кофейная гуща) составляют значительную часть нашего мусора. Идеальное решение – компостирование. Если у вас есть дача или сад, компостная куча – отличный способ превратить пищевые отходы в ценное удобрение. В некоторых городах развиваются программы по сбору органики. Опасные отходы: Батарейки, лампочки, ртутные градусники, старая бытовая техника, лекарства, аэрозоли – все это требует специальной утилизации. Ни в коем случае не выбрасывайте их в обычный мусорный бак! Ищите специализированные пункты приема в вашем городе. Текстиль: Старая одежда, обувь, постельное белье, если они в хорошем состоянии, можно отдать нуждающимся или в благотворительные фонды. Изношенные вещи могут быть переработаны на ветошь. Практические советы для дома Определите место: Выберите удобное место на кухне или в прихожей для нескольких контейнеров. Это могут быть специальные баки для сортировки, обычные ведра, прочные пакеты или даже красивые корзины. Ополосните и высушите: Все емкости (пластиковые бутылки, стеклянные банки, консервные банки) лучше ополоснуть перед тем, как отправлять на переработку. Это предотвратит появление неприятного запаха и сделает процесс более гигиеничным. Изучите местные правила: Условия приема вторсырья могут отличаться в зависимости от вашего региона и конкретных пунктов приема. Узнайте, что именно принимают в вашем городе и какие требования предъявляются к упаковке. Информацию можно найти на сайтах местных коммунальных служб или экологических организаций. Привлекайте всех членов семьи: Сортировка отходов – это командная работа. Объясните детям и взрослым, почему это важно, и как правильно распределять мусор. Не сдавайтесь! Возможно, поначалу это покажется немного непривычным, но очень быстро сортировка станет вашей доброй привычкой, которая принесет пользу не только вам, но и всей планете."
            ),
            Article(
                title: "Вторая жизнь вещей!",
                image: UIImage(named: "id2"),
                summary: "Статья о DIY-проектах и способах дать старым вещам новую жизнь, вместо того чтобы выбрасывать их.",
                date: Date().addingTimeInterval(-86400),
                content: "В мире, где потребление растёт, а свалки переполняются, концепция второй жизни вещей становится не просто модным трендом, но и жизненной философией. Это не только способ сократить количество мусора, но и проявить свою креативность, сэкономить деньги и, возможно, даже найти новое хобби. Зачем выбрасывать то, что можно превратить в нечто новое, полезное или красивое? Почему это важно? Повторное использование (или \"апсайклинг\" – от англ. upcycling) отличается от переработки. Переработка требует сложных промышленных процессов, энергии и воды для создания нового продукта из сырья. Повторное использование же зачастую происходит прямо у вас дома, без значительных затрат ресурсов, и зачастую превращает ненужную вещь в предмет с более высокой ценностью или функциональностью. Это прямое сокращение отходов, уменьшение спроса на новые товары и, как следствие, снижение нагрузки на окружающую среду. Креативные идеи для вашей \"второй жизни\" Загляните в свой шкаф, кладовку или даже мусорное ведро – вы удивитесь, сколько потенциальных сокровищ там спрятано! 1. Одежда и текстиль Из старых джинсов: Шейте сумки, косметички, подставки под горячее, чехлы для телефонов или даже оригинальные лоскутные одеяла. Потёртые джинсы могут стать стильными шортами. Футболки и майки: Превратите их в многоразовые тряпки для уборки, нитки для вязания ковриков или шопперы для похода в магазин. Постельное бельё и полотенца: Отличный материал для создания мешочков для хранения, кухонных полотенец, или основы для аппликаций. Одиночные носки: Используйте их как чехлы для гаджетов, мини-мешочки для хранения мелочей, или даже для создания кукол-перчаток. 2. Стеклянные банки и бутылки Банки: Идеальны для хранения круп, специй, домашнего варенья. Они могут стать оригинальными подсвечниками, вазами, стаканами, органайзерами для карандашей или инструментов. Бутылки: Превратите их в стильные вазы, ёмкости для самодельных напитков (лимонадов, настоек), основы для ламп или элементы декора, если их покрасить или обвязать. 3. Пластиковые бутылки и контейнеры Бутылки: Нижние части могут стать стаканчиками для рассады, органайзерами для канцелярских принадлежностей. Верхние части – воронками. Из больших бутылок можно сделать кормушки для птиц или вертикальные грядки. Пластиковые контейнеры от продуктов: Используйте для хранения мелочей, еды, как мини-парники для рассады или лотки для рукоделия. Пластиковые крышки: Их можно собирать для благотворительных акций или использовать в детском творчестве, создавать мозаики. 4. Бумага и картон Картонные коробки: Большие коробки – отличное сырьё для детских домиков, крепостей, автомобилей. Из них можно делать органайзеры для документов, ящики для хранения. Журналы, газеты, рекламные буклеты: Превратите их в материал для оригами, коллажей, создания бижутерии из бумажных бусин. Старые газеты отлично подойдут для упаковки хрупких предметов. Бумажные втулки от туалетной бумаги/полотенца: Используйте для организации проводов, хранения резинок для волос или как элементы для детских поделок (фигурки, домики). 5. Дерево и металл Деревянные паллеты: Популярный материал для создания диванов, столов, цветочных клумб, полок. Старые деревянные ящики: Могут стать полками, прикроватными тумбочками, ящиками для хранения игрушек. Металлические банки (из-под кофе, консервов): Очистите, покрасьте – и получите стильные стаканчики для ручек, вазы для сухоцветов, органайзеры для инструментов или даже мини-горшочки для растений. Где искать вдохновение? Интернет: Pinterest, YouTube, Instagram – неиссякаемые источники идей. Ищите по запросам \"upcycling\", \"DIY (Do It Yourself)\", \"повторное использование\", \"сделай сам\". Мастер-классы: Посещайте местные ярмарки, эко-фестивали – часто там проводятся мастер-классы по апсайклингу. Сообщества: Присоединяйтесь к онлайн- или оффлайн-сообществам, где люди делятся своими проектами и советами. Помните, что каждый предмет, которому вы дарите вторую жизнь, – это не просто уменьшение мусора. Это акт заботы о планете, проявление изобретательности и уникальности. Начните с малого, и вы увидите, как процесс повторного использования станет захватывающим и полезным занятием для вас и вашей семьи."
            ),
            Article(
                title: "Как организовать успешное эко-событие в своём районе?",
                image: UIImage(named: "id3"),
                summary: "Руководство по созданию локальных субботников, акций и инфо-дней.",
                date: Date().addingTimeInterval(+86400),
                content: "Хотите видеть свой район чище, зеленее и экологичнее? Устали ждать, пока кто-то начнёт действовать? Отличная новость: вы можете стать этим инициатором! Организация эко-события – будь то субботник, сбор вторсырья или просветительская акция – это реальный способ не только улучшить окружающую среду, но и сплотить соседей, вдохновить их на добрые дела. Это не так сложно, как кажется. Главное – начать! Шаг 1: Определите цель и формат Прежде чем что-либо предпринимать, чётко сформулируйте, чего вы хотите добиться. Субботник (акция по уборке): Самый популярный и наглядный формат. Цель – очистить конкретную территорию (парк, берег реки, двор). Пункт сбора вторсырья: Организация временного или постоянного пункта приёма определённых видов отходов (батареек, пластиковых крышечек, макулатуры). Просветительское мероприятие: Лекция, мастер-класс по сортировке мусора, компостированию, вторичному использованию вещей. Посадка деревьев/цветов: Инициатива по озеленению территории. Выбирайте формат, который наиболее актуален для вашего района и соответствует вашим ресурсам. Шаг 2: Планирование и подготовка Успех любого события кроется в деталях. Соберите команду: В одиночку будет тяжело. Найдите единомышленников среди соседей, друзей. Разделите обязанности: кто-то отвечает за инвентарь, кто-то – за информирование, кто-то – за контакты с властями. Выберите дату и время: Оптимально – выходной день, когда большинство людей свободны. Учитывайте погодные условия. Получите разрешение (если необходимо): Если мероприятие проводится на общественной территории (парк, сквер, улицы), возможно, потребуется согласование с местными органами власти (хукумат, жилищно-коммунальные службы). Обычно для субботников это несложно, но лучше уточнить заранее. Это также поможет получить поддержку в виде вывоза собранного мусора. Определите место: Точная локация для уборки, сбора или проведения лекции. Инвентарь и ресурсы: Для субботника: Мусорные мешки (желательно прочные), перчатки, грабли, лопаты, возможно, вода для участников. Для сбора вторсырья: Контейнеры для разных видов отходов, весы (если планируете взвешивать), транспорт для вывоза на пункт приёма. Для просветительских акций: Место для проведения, проектор, стулья, информационные материалы. Для посадки деревьев: Саженцы, лопаты, вода для полива. Партнёры: Возможно, местные НПО, школы, бизнес или управляющая компания готовы предоставить инвентарь, информационную поддержку или помочь с вывозом отходов. Шаг 3: Информирование и привлечение участников Без людей событие не состоится! Объявления: Разместите яркие и информативные объявления на досках у подъездов, в магазинах, на детских площадках. Укажите дату, время, место, цель мероприятия, что взять с собой и кто организатор. Социальные сети и мессенджеры: Создайте чат в WhatsApp/Viber для района, событие в Facebook/Instagram, используйте местные группы. 'Сарафанное радио': Расскажите друзьям, соседям, коллегам. Личное приглашение часто работает лучше всего. Сотрудничество со СМИ: Если событие крупное, можно попробовать привлечь местные СМИ для освещения. Шаг 4: Проведение события Приходите заранее: Подготовьте место, разложите инвентарь. Приветствие и инструктаж: Коротко объясните участникам задачи, правила безопасности (особенно при уборке), покажите, куда складывать тот или иной вид мусора. Создайте позитивную атмосферу: Включите музыку, предложите чай/кофе, устройте небольшой пикник после работы. Сделайте процесс приятным и запоминающимся. Фотографируйте: Делайте снимки 'до' и 'после', лица довольных участников. Это отличный материал для отчётов и будущих мероприятий. Организуйте вывоз: Убедитесь, что собранный мусор и вторсырьё будут вывезены в оговорённое место. Шаг 5: После события Не расслабляйтесь сразу – важен завершающий этап! Поблагодарите участников: Отправьте сообщения благодарности в чаты, сделайте пост в соцсетях. Отметьте вклад каждого. Поделитесь результатами: Опубликуйте фотографии, статистику (сколько мешков мусора собрано, сколько килограммов вторсырья). Это покажет людям, что их усилия принесли реальную пользу. Отчёт для властей/партнёров: Если были договорённости, предоставьте информацию о проделанной работе. Обсудите планы на будущее: Что удалось, что можно улучшить? Какие ещё эко-инициативы можно реализовать в районе? Организация эко-события – это не только про уборку мусора, но и про создание сообщества, проявление активной гражданской позиции. Начните с малого, и вы увидите, как ваша инициатива вдохновит других и принесёт реальные изменения в вашем районе."
            )
        ]
        tableView.reloadData()
    }

    // MARK: - UITableViewDataSource

    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return articles.count
    }

    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        guard let cell = tableView.dequeueReusableCell(withIdentifier: "ArticleCell", for: indexPath) as? ArticleCell else {
            return UITableViewCell()
        }
        let article = articles[indexPath.row]
        cell.configure(with: article)
        cell.readButton.tag = indexPath.row
        cell.readButton.addTarget(self, action: #selector(readButtonTapped(_:)), for: .touchUpInside)
        return cell
    }

    // MARK: - UITableViewDelegate (дополнительно можно реализовать выбор)

    // MARK: - Actions

    @objc func readButtonTapped(_ sender: UIButton) {
        let index = sender.tag
        let article = articles[index]
        let detailVC = ArticleDetailViewController(article: article)
        navigationController?.pushViewController(detailVC, animated: true)
    }
}
